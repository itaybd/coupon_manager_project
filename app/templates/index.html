{% extends 'base.html' %}

{% block title %}קופונים והנחות אונליין - Coupon Master{% endblock %}

{% block content %}
<!-- Admin flash message -->
{% if show_admin_message and admin_message %}
<div class="admin-flash-message">
    <p>{{ admin_message.message_text | replace("\n", "<br>") | safe }}</p>
    {% if admin_message.link_url %}
        <a href="{{ admin_message.link_url }}" target="_blank" class="admin-message-button">
            {{ admin_message.link_text if admin_message.link_text else "למידע נוסף" }}
        </a>
    {% endif %}
    <form method="post" action="{{ url_for('admin_messages_bp.dismiss_admin_message') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="close-button">×</button>
    </form>
</div>
{% endif %}

<section class="hero">
    <!-- Hidden H1 for SEO keywords -->
    <h1 style="display:none;">קופונים והנחות בלעדיות בישראל - חסוך כסף עכשיו!</h1>
    <h2>{{ greeting }}, {{ current_user.first_name }}!</h2>

    {% if show_expiring_alert %}
    <!-- Alert for expiring coupons -->
    <div class="expiring-coupons-alert">
        <!-- Close alert button -->
        <a class="close-expiring-alert" href="{{ url_for('profile.dismiss_expiring_alert') }}">×</a>
        <p><strong>שים לב!</strong> יש לך {{ expiring_coupons|length }} קופונים שעומדים לפוג תוקפם בשבוע הקרוב:</p>
        <ul class="expiring-coupons-list">
            {% for c in expiring_coupons %}
            <li>
                <strong>{{ c.company }}</strong> -
                {% set expiration_date = c.expiration.strftime('%d/%m/%Y') %}
                {% set today_date = current_date.strftime('%d/%m/%Y') %}
                {% set tomorrow_date = (current_date + timedelta(days=1)).strftime('%d/%m/%Y') %}
                {% if expiration_date == today_date %}
                    התוקף יפוג היום בלילה
                {% elif expiration_date == tomorrow_date %}
                    התוקף יפוג מחר
                {% else %}
                    התוקף יפוג ב-<strong>{{ expiration_date }}</strong>
                {% endif %}
                <span class="coupon-button-wrapper">
                    <a class="view-coupon-button" href="{{ url_for('coupons.coupon_detail', id=c.id) }}">
                        צפה בקופון
                    </a>
                </span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="total-value">
        <p>נשאר לך בארנק:</p>
        <h1>{{ '%.2f'|format(total_value) }} ₪</h1>
    </div>

    <!-- Hidden text for SEO keywords -->
    <p class="hidden-text">
      מצא את כל הקופונים וההנחות במקום אחד! אפליקציית <strong>Coupon Master</strong> עוזרת לך 
      <strong>לחסוך כסף בקניות</strong> בכל החנויות הגדולות בישראל.
    </p>
    
    <!-- CHANGED: Replaced savings text with centered statistics button -->
    <div style="display: flex; justify-content: center;">
      <button id="open-stats-modal" class="stats-button">
          <i class="fas fa-chart-bar"></i> סטטיסטיקות חיסכון
      </button>
    </div>
</section>

<!-- Company cards row -->
<div id="company-cards-row" class="company-cards-row"></div>

<div class="usage-forms-container">
    <!-- Form for automatic coupon usage report -->
    <section class="usage-form-wrapper">
        <form method="POST" action="{{ url_for('coupons.parse_usage_text') }}">
            {{ usage_form.hidden_tag() }}
            <div class="input-wrapper">
                <label for="usage_explanation">דיווח אוטומטי על שימוש בקופונים</label>
                <textarea id="usage_explanation"
                          name="usage_explanation"
                          rows="2"
                          class="input-field_centered"
                          placeholder="{% if current_user.gender == 'male' %}תפרט כאן באלו קופונים השתמשת ובכמה{% else %}תפרטי כאן באלו קופונים השתמשת ובכמה{% endif %}"></textarea>
            </div>
            <div class="button-with-explanation">
                <button type="submit" class="submit-button">שלח</button>
                <button type="button" class="tooltip-button-mobile" aria-label="מידע נוסף">❔</button>
                <div class="tooltip">
                    יש לך עוד {{ current_user.slots_automatic_coupons }} סלוטים זמינים למילוי אוטומטית.
                    <span class="close-tooltip">×</span>
                </div>
            </div>
        </form>
    </section>

    <!-- Form for automatic coupon addition -->
    <section class="usage-form-wrapper">
        <form method="POST" action="{{ url_for('coupons.add_coupon') }}">
            {{ sms_form.hidden_tag() }}
            <div class="input-wrapper">
                <label for="sms_text">זיהוי והוספה אוטומטית של קופון</label>
                <textarea class="input-field_centered"
                          id="sms_text"
                          name="sms_text"
                          rows="2"
                          placeholder="{% if current_user.gender == 'male' %}תפרט כאן את הפרטים של הקופון שקנית להוספה אוטומטית שלו{% else %}תפרטי כאן את הפרטים של הקופון שקנית להוספה אוטומטית שלו{% endif %}"></textarea>
            </div>
            <div class="button-with-explanation">
                <input class="submit-button" id="submit_sms" name="submit_sms" type="submit" value="הבא">
                <button type="button" class="tooltip-button-mobile" aria-label="מידע נוסף">❔</button>
                <div class="tooltip">
                    יש לך עוד {{ current_user.slots_automatic_coupons }} סלוטים זמינים למילוי אוטומטית.
                    <span class="close-tooltip">×</span>
                </div>
            </div>            
        </form>
    </section>
</div>

<!-- Coupon list section -->
<section class="coupon-list">
    {% macro get_company_logo(coupon) %}
        {% set company_lower = coupon.company.lower() %}
        <img src="{{ url_for('static', filename=company_logo_mapping.get(company_lower, 'images/default.png')) }}"
             alt="{{ coupon.company }} Logo" class="company-logo">
    {% endmacro %}

    {% set coupon_categories = [
        (active_coupons, "קופונים פעילים"),
        (active_one_time_coupons, "קופונים חד פעמיים"),
        (coupons_for_sale, "קופונים למכירה")
    ] %}
    {% for coupons, title in coupon_categories %}
        {% if coupons %}
            <h3 class="coupon-section-title">{{ title }}</h3>
            <div class="coupon-container-index">
                {% for coupon in coupons %}
                <!-- NEW COUPON CARD STRUCTURE -->
                <div class="coupon-card-index-wrapper"
                     data-company="{{ coupon.company }}"
                     data-coupon-code="{{ coupon.code }}"
                     data-coupon-id="{{ coupon.id }}"
                     data-remaining="{{ '%.2f'|format(coupon.remaining_value) }}"
                     data-logo-src="{{ url_for('static', filename=company_logo_mapping.get(coupon.company|lower, 'images/default.png')) }}"
                     {% if coupon.is_one_time %}
                         data-is-one-time="true" data-purpose="{{ coupon.purpose }}"
                     {% else %}
                         data-is-one-time="false"
                     {% endif %}
                     {% if coupon.cvv %}
                         data-coupon-cvv="{{ coupon.cvv }}"
                     {% endif %}
                     {% if coupon.card_exp %}
                         data-coupon-card-index-exp="{{ coupon.card_exp }}"
                     {% endif %}>
                    <div class="coupon-card-index">
                        <div class="coupon-header">
                            <img src="{{ url_for('static', filename=company_logo_mapping.get(coupon.company|lower, 'images/default.png')) }}" 
                                 alt="{{ coupon.company }} Logo" class="company-logo">
                            <h4>{{ coupon.company }}</h4>
                        </div>
                        
                        <div class="coupon-content">
                            <div class="coupon-code">
                                <span class="label">קוד קופון:</span>
                                <span class="value">{{ coupon.code }}</span>
                            </div>
                            
                            {% if coupon.is_one_time %}
                            <div class="coupon-purpose">
                                <span class="label">מטרה:</span>
                                <span class="value">{{ coupon.purpose }}</span>
                            </div>
                            {% else %}
                            <div class="coupon-value">
                                <span class="label">יתרה:</span>
                                <span class="value">{{ '%.2f'|format(coupon.remaining_value) }} ₪</span>
                            </div>
                            
                            <div class="usage-progress">
                                <div class="progress-text">
                                    {% if coupon.value > 0 %}
                                      שימוש: {{ (coupon.used_value / coupon.value * 100)|round(0)|int }}%
                                    {% else %}
                                      שימוש: 0%
                                    {% endif %}
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: {% if coupon.value > 0 %}{{ (coupon.used_value / coupon.value * 100)|round(2) }}{% else %}0.0{% endif %}%"></div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if title == "קופונים למכירה" %}
                            <div class="sale-price">
                                <span class="label">מחיר מכירה:</span>
                                <span class="value" style="color: var(--accent-color);">{{ '%.2f'|format(coupon.cost) }} ₪</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="coupon-actions">
                            <a href="{{ url_for('coupons.coupon_detail', id=coupon.id) }}" class="action-button view-details">
                                <i class="fas fa-info-circle"></i>
                                <span>פרטים</span>
                            </a>
                            <button class="action-button show-code">
                                <i class="fas fa-eye"></i>
                                <span>הצג קוד</span>
                            </button>
                            {% if not coupon.is_one_time %}
                            <button class="action-button update-usage">
                                <i class="fas fa-edit"></i>
                                <span>עדכן שימוש</span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="text-align: center; color: var(--gray);">אין לך {{ title }} כרגע.</p>
        {% endif %}
    {% endfor %}
</section>

<!-- Modal for displaying company coupons with animation -->
<div id="companyModal" class="modal">
  <div class="modal-content">
    <!-- Close modal button -->
    <span class="close-modal">×</span>
    <!-- Company title -->
    <h2 id="modal-company-name">קופונים מחברת ...</h2>
    <!-- Company logo -->
    <img id="modal-company-logo" alt="Company Logo" style="display: block;" src="/static/images/carrefour.png">
    <!-- Total remaining value -->
    <p id="modal-total-remaining" style="font-size: 1.2em; font-weight: bold; margin: 5px 0;"></p>
    <ul id="modal-coupons-list"></ul>
  </div>
</div>

<!-- Modal for updating coupon usage with animation -->
<div id="usageModal" class="modal">
  <div class="modal-content usage-modal-content" style="max-width: 600px;">
    <span class="close-usage-modal">×</span>
    <h3>עדכון סכום שימוש</h3>
    <!-- Dynamic content will be filled here -->
    <h2 id="usage-modal-company" style="color: #00bfff; font-size: 1.8em; margin-bottom: 5px;"></h2>
    <img id="usage-modal-logo" alt="Company Logo" style="display: block; margin: 10px auto 0 auto; width: 80px; height: 80px;" src="/static/images/carrefour.png">
    <p id="usage-modal-code" style="margin-bottom:10px;"><strong></strong></p>
    <p id="usage-modal-remaining" style="margin-bottom:10px;"><strong>יתרה נוכחית: <span id="remainingValue">70.30</span> ש"ח</strong></p>
    <input type="number" id="usageAmount" step="0.01" placeholder="בכמה השתמשת?" style="padding:8px; width:200px;">
    <br>
    <button id="usageConfirmButton" style="margin-top:10px; padding:8px 16px; background-color:#3498db; color:#fff; border:none; border-radius:5px; cursor:pointer;">
      אישור
    </button>
    <button id="updateFullAmountButton" style="margin-top:10px; padding:8px 16px; background-color:#2ecc71; color:#fff; border:none; border-radius:5px; cursor:pointer;">
      עדכון כל היתרה
    </button>
    <div id="usageErrorMsg" style="color:red; margin-top:10px; display:none;"></div>
  </div>
</div>

<!-- Modal for large display with animation -->
<div id="bigDisplayModal" class="modal">
  <div class="modal-content">
    <span class="close-big-modal">×</span>
    <h2 id="bigModalCompanyName">Be שופרסל</h2>
    <img id="bigModalLogo" alt="Logo" style="width:120px;height:120px;object-fit:cover;margin:10px auto;border-radius:8px;" src="/static/images/be_shufersal.png">
    <h1 id="bigModalCouponCode" style="margin-top:20px;">91381000401555109674</h1>
    <!-- Block for displaying CVV and card expiration -->
    <div id="bigModalExtraDetails" style="margin-top:20px; display:none;">
      <h1 id="bigModalCouponCVV" style="margin:0; font-weight: bold;"></h1>
      <h1 id="bigModalCardExp" style="margin:0; font-weight: bold;"></h1>
    </div>
    <!-- QR code element for coupon code -->
    <div id="qrcode" style="margin: 20px auto; width: 200px; height: 200px;"></div>
  </div>
</div>

<!-- Modal for statistics with charts, filters and scrolling -->
<div id="statsModal" class="modal">
  <div class="modal-content stats-modal-content">
    <span class="close-stats-modal">×</span>
    <h2>סטטיסטיקות החיסכון שלך</h2>
    
    <!-- Company filters with proper wrapping behavior -->
    <div class="filters-container">
      <span>סינון לפי חברות:</span>
      <div class="company-filters" id="company-filters">
        <!-- Dynamic filter controls will be added here -->
      </div>
    </div>
    
    <!-- Statistics cards with original desktop layout -->
    <div class="stats-summary">
      <div class="stats-card" id="total-savings-card">
        <h3>סך החיסכון שלך</h3>
        <div class="big-number">{{ '%.0f'|format(total_savings) }} ₪</div>
        <p>מתוך {{ '%.0f'|format(total_coupons_value) }} ₪ אפשריים</p>
      </div>
      <div class="stats-card" id="savings-percentage-card">
        <h3>אחוז החיסכון</h3>
        <div class="big-number">{{ '%.0f'|format(percentage_savings) }}%</div>
        <p>מכלל הקופונים</p>
      </div>
      <!-- New statistics cards for total coupons and usage rate -->
      <div class="stats-card" id="total-coupons-card">
        <h3>מספר קופונים</h3>
        <div class="big-number">{{ total_coupons_count }}</div>
        <p>{{ active_coupons_count if active_coupons_count is defined else "0" }} מתוכם פעילים</p>
      </div>
      <div class="stats-card" id="average-usage-card">
        <h3>אחוז ניצול ממוצע</h3>
        <div class="big-number">{{ '%.0f'|format(average_usage_percentage) }}%</div>
        <p>ממוצע ניצול לכל הקופונים</p>
      </div>
    </div>
    
    <div class="stats-charts">
      <div class="chart-container">
        <h3>התפלגות החיסכון לפי חברות</h3>
        <div id="companySavingsChart" class="chart"></div>
      </div>
      <div class="chart-container">
        <h3>שימוש לאורך זמן</h3>
        <div id="timelineChart" class="chart"></div>
      </div>
    </div>
    
    <div class="stats-details">
      <h3>פירוט החיסכון לפי חברות</h3>
      <div class="savings-table-wrapper">
        <table id="savingsTable" class="savings-table">
          <thead>
            <tr>
              <th>חברה</th>
              <th>סך חיסכון</th>
              <th>% מהחברה</th>
            </tr>
          </thead>
          <tbody>
            <!-- Table will be populated via JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="export-buttons">
    <a href="{{ url_for('export.export_excel') }}" class="export-button">
        <i class="fas fa-file-excel" aria-hidden="true"></i> ייצא ל-Excel
    </a>
    <a href="{{ url_for('export.export_pdf') }}" class="export-button">
        <i class="fas fa-file-pdf" aria-hidden="true"></i> ייצא ל-PDF
    </a>
</div>

{% if current_user.is_admin %}
<form action="{{ url_for('coupons.update_all_active_coupons') }}" method="post"
      style="text-align: center; margin-top: 40px; margin-bottom: 20px;">
    {{ usage_form.hidden_tag() }}
    <button type="submit" class="action-button small-button multipass-update-button">
      <i class="fa fa-refresh"></i> עדכן את כל הקופונים הפעילים מ-Multipass
  </button>
</form>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tooltip.css') }}">

<!-- ADDED: Chart.js library for statistics -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<!-- ADDED: QR Code library for coupon display -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
/* ===== General Styles and Notifications ===== */
.admin-flash-message {
    background-color: #fff8e1;
    color: #856404;
    border: 1px solid #ffeeba;
    padding: 10px 15px;
    border-radius: 6px;
    font-size: 1em;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin: 15px auto;
    max-width: 800px;
    width: 90%;
    position: relative;
}
.admin-flash-message .close-button {
    position: absolute;
    top: 8px;
    right: 10px;
    background: none;
    border: none;
    font-size: 1.1em;
    cursor: pointer;
    color: inherit;
}
.admin-message-button {
    display: inline-block;
    background-color: #3498db;
    color: white;
    padding: 6px 10px;
    border-radius: 5px;
    text-decoration: none;
    font-size: 0.85em;
    font-weight: bold;
    transition: background 0.3s ease-in-out;
    margin-top: 2px;
}
.admin-message-button:hover {
    background-color: #2980b9;
}

/* Expiring coupons alert */
.expiring-coupons-alert {
    background-color: #fff8e1;
    color: #000;
    padding: 15px 20px;
    border-radius: 8px;
    font-size: 1.1em;
    position: relative;
    margin-top: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    text-align: center;
}
.close-expiring-alert {
    position: absolute;
    top: 5px;
    right: 10px;
    font-size: 1.2em;
    text-decoration: none;
    color: #ff9800;
    font-weight: bold;
}
.expiring-coupons-list {
    list-style: none;
    margin: 10px 0 0;
    padding: 0;
}
.expiring-coupons-list li {
    margin-bottom: 5px;
}
.coupon-button-wrapper {
    display: inline;
}

/* Coupon view button */
.view-coupon-button {
    display: inline-block;
    margin-right: 5px;
    background-color: #3498db;
    color: #fff;
    text-decoration: none;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 0.9em;
    font-weight: normal;
}
.view-coupon-button:hover {
    background-color: #2980b9;
}

/* ===== Titles and Amounts ===== */
.total-value p {
    font-size: 1.25em;
    font-weight: bold;
}
.hidden-text {
    display: none;
}

/* ===== Company Cards Row ===== */
.company-cards-row {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    margin: 20px auto 30px auto;
    max-width: 1000px;
}
.company-card-box {
    background-color: #fff;
    border: 1px solid #eee;
    border-radius: 8px;
    width: 200px;
    text-align: center;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.company-card-box:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.company-card-box img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    margin-bottom: 10px;
}
.company-card-box h3 {
    margin: 0;
    font-size: 1.1em;
    font-weight: bold;
    color: #333;
}
.company-card-box p {
    margin: 5px 0;
    font-size: 0.9em;
    color: #666;
}
@media (max-width: 450px) {
    .company-cards-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        padding: 0 10px;
    }
    .company-card-box {
        width: 100%;
    }
    .company-card-box:nth-child(odd):last-child {
        grid-column: 1 / -1;
        justify-self: center;
        width: 50%;
    }
}

/* ===== Forms (Usage Report / Add Coupon) ===== */
.usage-forms-container {
    display: flex;
    gap: 5px;
    justify-content: center;
    align-items: stretch;
    margin: 20px auto;
    max-width: 800px;
    border-radius: 10px;
}
.usage-form-wrapper {
    flex: 1;
    max-width: 360px;
    width: 100%;
    display: flex;
    flex-direction: column;
}
.usage-form-wrapper form {
    display: flex;
    flex-direction: column;
    height: 100%;
}
.input-wrapper {
    margin-bottom: 10px;
}
.button-with-explanation {
    position: relative;
    display: inline-block;
    margin-top: auto;
}
.button-with-explanation:hover .tooltip,
.tooltip-trigger:hover .tooltip {
    display: block;
}
.tooltip-button-mobile {
    margin-left: 10px;
}

/* ===== Coupon List and Cards ===== */
.coupon-container-index {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
    gap: 20px;
    margin-top: 20px;
    justify-content: center;
    grid-auto-flow: row;
    grid-template-rows: auto;
}

/* טיפול בקופון בודד בשורה במסכים גדולים */
.coupon-card-index-wrapper {
    width: 100%;
    display: flex;
    justify-content: center;
}

.coupon-card-index {
    width: 100%;
    max-width: 260px; /* רוחב מקסימלי קבוע לכל תיבת קופון */
}

@media (max-width: 992px) {
    .coupon-card-index {
        max-width: 100%; /* רוחב מלא במסכים בינוניים */
    }
}

@media (max-width: 600px) {
    .coupon-container-index {
      display: grid;
      /* שימוש ב-minmax עם רוחב מינימלי קטן יותר כדי לאפשר יותר גמישות */
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 20px;
      margin-top: 20px;
      justify-content: center;
    }
    
    /* אם יש רק קופון אחד בשורה האחרונה במסכים קטנים */
    .coupon-card-index-wrapper:last-child:nth-child(odd) {
        grid-column-start: 1;
        grid-column-end: 3;
        width: 100%;
        display: flex;
        justify-content: center;
    }
    
    .coupon-card-index-wrapper:last-child:nth-child(odd) .coupon-card-index {
        width: 100%;
        max-width: 200px; /* אותו רוחב כמו קופונים אחרים */
    }
}


.coupon-card-index-wrapper {
    overflow: visible; /* שינוי מ-hidden ל-visible */
    padding-top: 5px; /* הוספת ריפוד לאפשר את התנועה כלפי מעלה */
}


.coupon-card-index {
    background-color: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    height: 100%;
    display: flex;
    flex-direction: column;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.coupon-card-index:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

.coupon-header {
    padding: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    border-bottom: 1px solid #eee;
}

.coupon-header img {
    width: 70px;
    height: 70px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 8px;
}

.coupon-header h4 {
    margin: 0;
    font-size: 1.2em;
    font-weight: 600;
    color: #333;
}

.coupon-content {
    padding: 16px;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.coupon-code, .coupon-value, .sale-price {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* סגנון ספציפי עבור coupon-purpose */
.coupon-purpose {
    display: flex;
    flex-direction: column; /* מסדר את האלמנטים בעמודה */
    align-items: flex-start; /* יישור לימין */
    gap: 5px; /* מרווח בין התווית לתוכן */
}

.coupon-purpose .label {
    font-size: 0.85em;
    color: #777;
    margin-bottom: 3px; /* מרווח נוסף מתחת לתווית */
}

.coupon-purpose .value {
    width: 100%; /* הערך יתפוס את כל הרוחב */
    font-weight: 600;
    color: #333;
    word-break: break-word; /* מאפשר שבירת מילים */
}

.label {
    font-size: 0.85em;
    color: #777;
}

.value {
    font-weight: 600;
    color: #333;
}

.usage-progress {
    margin-top: 8px;
}

.progress-text {
    display: flex;
    justify-content: space-between;
    font-size: 0.85em;
    color: #666;
    margin-bottom: 4px;
}

.progress-bar {
    height: 8px;
    background-color: #eee;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background-color: var(--primary-color, #3498db);
    border-radius: 4px;
}

.coupon-actions {
    padding: 16px;
    display: flex;
    gap: 8px;
    border-top: 1px solid #eee;
}

.action-button {
    flex: 1;
    background-color: #f5f5f5;
    color: #555;
    border: none;
    border-radius: 8px;
    padding: 8px;
    font-size: 0.75em;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: background-color 0.2s ease, color 0.2s ease;
    text-decoration: none;
}

.action-button i {
    font-size: 1em;
}

.action-button:hover {
    background-color: var(--primary-color, #3498db);
    color: #fff;
}

.view-details:hover {
    background-color: var(--secondary-color, #2ecc71);
}

.show-code:hover {
    background-color: var(--accent-color, #9b59b6);
}

.update-usage:hover {
    background-color: var(--success-color, #27ae60);
}

.coupon-section-title {
    text-align: center;
    margin-top: 30px;
    color: #444;
    font-weight: 600;
}

/* ===== Export Buttons ===== */
.export-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
}
.export-button {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background-color: #2ecc71;
    color: #fff;
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 5px;
}
.export-button:hover {
    background-color: #27ae60;
}

/* ===== Responsiveness ===== */
@media (max-width: 1200px) {
    .coupon-container-index {
        grid-template-columns: repeat(3, 1fr);
    }
}
@media (max-width: 992px) {
    .coupon-container-index {
        grid-template-columns: repeat(2, 1fr);
    }
}
@media (max-width: 768px) {
    /* עיצוב מעודכן לכפתורים במסכים קטנים */
    .coupon-actions {
        flex-direction: row; /* שינוי מ-column ל-row */
        flex-wrap: wrap; /* מאפשר מעבר לשורה חדשה */
        padding: 10px;
        justify-content: space-between; /* רווח שווה בין הכפתורים */
        gap: 8px; /* מרווח בין הכפתורים */
    }
    
    /* כל הכפתורים באותו גודל */
    .coupon-actions .action-button {
        flex: 0 0 calc(50% - 4px); /* כל כפתור בשורה הראשונה תופס בדיוק חצי מהרוחב פחות המרווח */
        margin: 0; /* ביטול מרווחים מיותרים */
        padding: 6px 0;
    }
    
    /* הכפתור השלישי תופס שורה חדשה ומרוכז */
    .coupon-actions .action-button:last-child {
        flex: 0 0 calc(50% - 4px); /* בדיוק באותו גודל כמו האחרים */
        margin: 0 auto; /* מירכוז אופקי */
    }
    .action-button {
        padding: 6px 0;
    }
}
@media (max-width: 600px) {
    .coupon-container-index {
        grid-template-columns: repeat(2, 1fr); /* שני קופונים בשורה */
        gap: 8px; /* רווח קטן יותר בין הקופונים */
        padding: 0 8px; /* פדינג קטן יותר בצדדים */
        width: 100%; /* להבטיח שיתפוס את כל הרוחב */
        max-width: 100%; /* להבטיח שאין הגבלת רוחב */
        justify-content: center; /* מרכוז הקופונים */
    }
    
    .coupon-card-index-wrapper {
        width: 100%; /* להבטיח שכל קופון תופס את מלוא הרוחב של התא שלו */
    }
    
    .coupon-card-index {
        width: 100%; /* להבטיח שהכרטיס תופס את מלוא הרוחב */
    }
    
    /* הקטנת תוכן פנימי לחסוך מקום */
    .coupon-header {
        padding: 8px;
    }
    
    .coupon-header img {
        width: 45px; 
        height: 45px;
        margin-bottom: 5px;
    }
    
    .coupon-header h4 {
        font-size: 1em;
    }
    
    .coupon-content {
        padding: 8px;
        gap: 8px;
    }
    
    .label, .value {
        font-size: 0.8em;
    }
    
    .coupon-actions {
        padding: 8px;
    }
    
    .action-button {
        padding: 6px 4px;
        font-size: 0.7em;
    }
      
}
/* Original desktop styling for charts */
.stats-charts {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin: 20px 0;
}
.chart-container {
  flex: 1 1 300px;
  min-height: 300px;
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  padding: 15px;
}

.coupon-code {
      flex-direction: column; /* הפוך לכיוון של עמודה במקום שורה */
      align-items: flex-start; /* יישור לתחילת השורה */
  }
  
  .coupon-code .label {
      margin-bottom: 3px; /* מרווח קטן בין התווית לערך */
  }
  
  .coupon-code .value {
      width: 100%; /* הערך יתפוס את כל הרוחב */
      word-break: break-word; /* מאפשר שבירת מילים */
      font-size: 0.9em; /* פונט קצת יותר קטן בניידים */
  }

  .stats-charts {
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
  }
  
  .chart-container {
    flex: none;
    width: 100%;
    min-height: 250px;
    padding: 10px;
    margin-bottom: 15px;
  }
  
  .chart {
    height: 200px;
  }
}
/* ===== Tooltip ===== */
.tooltip {
    display: none;
    position: absolute;
    background-color: #333;
    color: #fff;
    padding: 8px 10px;
    border-radius: 6px;
    font-size: 0.9em;
    max-width: 250px;
    z-index: 9999;
}
.tooltip::after {
    content: "";
    position: absolute;
    border-width: 5px;
    border-style: solid;
    border-color: #333 transparent transparent transparent;
    top: 0;
    left: 10px;
    transform: translateY(-100%);
}
.close-tooltip {
    float: right;
    cursor: pointer;
    margin-left: 8px;
}

/* ===== Centering Statistics Button ===== */
.stats-button {
  background-color: #3498db;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 0.9em;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  margin: 10px auto;
  transition: background-color 0.2s ease;
}
.stats-button:hover {
  background-color: #2980b9;
}

/* ===== Modal Styles with Animation ===== */
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.4);
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}
.modal.active {
  opacity: 1;
  visibility: visible;
}
.modal-content {
  background-color: #fff;
  margin: 8% auto;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 500px;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  box-sizing: border-box;
  text-align: center;
}
.modal-content h2,
.modal-content h3 {
  margin: 10px 0;
}
.close-modal,
.close-usage-modal,
.close-big-modal,
.close-stats-modal {
  position: absolute;
  top: 10px;
  right: 20px;
  font-size: 1.5em;
  cursor: pointer;
}
#modal-company-logo {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
  margin: 10px auto 0 auto;
  display: block;
}
#modal-coupons-list {
  margin-top: 20px;
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 15px;
  align-items: center;
  list-style: none;
  padding: 0;
}
#modal-coupons-list li {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
}
#modal-coupons-list li a {
  text-decoration: none;
  color: #3498db;
  margin-bottom: 5px;
  text-align: center;
}
#modal-coupons-list li a:hover {
  text-decoration: underline;
}
.coupon-info-buttons {
  display: flex;
  justify-content: center;
  gap: 10px;
}
.update-usage-btn,
.show-big-btn {
  border: none;
  border-radius: 5px;
  padding: 4px 8px;
  cursor: pointer;
  color: #fff;
  font-size: 0.9em;
}
.update-usage-btn {
  background-color: #27ae60;
}
.update-usage-btn:hover {
  background-color: #229954;
}
.show-big-btn {
  background-color: #8e44ad;
}
.show-big-btn:hover {
  background-color: #7d3c98;
}

/* Fix long text wrapping in modal */
#bigModalCouponCode {
  word-wrap: break-word;
  overflow-wrap: break-word;
  white-space: normal;
  text-align: center;
  max-width: 100%;
}

/* ===== Statistics Modal Specific Styles ===== */
.stats-modal-content {
  max-width: 800px;
  padding: 25px;
  max-height: 80vh;
  overflow-y: auto;
}

/* Original desktop styling for stats cards */
.stats-summary {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  margin: 20px 0;
  gap: 20px;
}
.stats-card {
  background-color: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  flex: 1;
  min-width: 200px;
  text-align: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.big-number {
  font-size: 2.5em;
  font-weight: bold;
  color: #3498db;
  margin: 10px 0;
}

/* Original desktop styling for charts */
.stats-charts {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin: 20px 0;
}
.chart-container {
  flex: 1 1 300px;
  min-height: 300px;
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  padding: 15px;
}
.chart {
  width: 100%;
  height: 250px;
}

/* Table styling with wrapper for scrolling if needed */
.savings-table-wrapper {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.savings-table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  min-width: 300px; /* Ensures table doesn't get too narrow */
}
.savings-table th,
.savings-table td {
  padding: 10px;
  text-align: right;
  border-bottom: 1px solid #ddd;
}
.savings-table th {
  background-color: #f2f2f2;
  position: sticky;
  top: 0;
}

/* Filters container with proper wrapping */
.filters-container {
  margin: 10px 0;
  padding: 10px 15px;
  background-color: #f8f9fa;
  border-radius: 8px;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  justify-content: center;
}
.filters-container span {
  font-weight: bold;
  margin-right: 10px;
}
.company-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin: 0 auto;
  width: 100%;
  text-align: center;
}
.company-filter-item {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  padding: 4px 8px;
  background-color: #fff;
  border-radius: 4px;
  border: 1px solid #ddd;
  cursor: pointer;
  font-size: 0.85em;
  text-align: center;
  min-width: 90px;
  margin: 0 auto;
  user-select: none;
}
.company-filter-item span {
  display: block;
  width: 100%;
  text-align: center;
  margin: 0 auto;
  pointer-events: none;
}
.company-filter-item.active {
  background-color: #e3f2fd;
  border-color: #2196F3;
}

/* Mobile-specific styles */
@media (max-width: 767px) {
  .stats-modal-content {
    padding: 15px;
    margin: 5% auto;
    width: 95%;
  }
  
  /* Mobile optimized cards - 2 per row */
  .stats-summary {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }
  
  .stats-card {
    min-width: unset;
    padding: 10px;
  }
  
  .stats-card h3 {
    font-size: 0.9em;
  }
  
  .big-number {
    font-size: 1.8em;
    margin: 5px 0;
  }
  
  .stats-card p {
    font-size: 0.8em;
    margin: 5px 0;
  }
  
  /* Mobile optimized charts - stacked */
  .stats-charts {
    flex-direction: column;
  }
  
  .chart-container {
    flex: none;
    min-height: 250px;
    padding: 10px;
  }
  
  .chart {
    height: 200px;
  }
  
  .stats-details h3 {
    font-size: 1.1em;
  }
  
  .savings-table th,
  .savings-table td {
    padding: 8px 5px;
    font-size: 0.9em;
  }
  
  .close-stats-modal {
    top: 5px;
    right: 10px;
  }
  
  .coupon-info-buttons {
    flex-direction: column;
    gap: 5px;
    width: 100%;
  }
  
  .update-usage-btn,
  .show-big-btn {
    width: 100%;
    padding: 6px 0;
  }
}

/* For very small devices */
@media (max-width: 400px) {
  .coupon-actions {
        gap: 6px; /* מרווח קטן יותר במסכים קטנים */
    }
    
    .coupon-actions .action-button {
        flex: 0 0 calc(50% - 3px); /* התאמה למרווח הקטן יותר */
    }
    
    .coupon-actions .action-button:last-child {
        flex: 0 0 calc(50% - 3px); /* התאמה למרווח הקטן יותר */
    }

  .stats-card {
    padding: 8px 5px;
  }
  
  .big-number {
    font-size: 1.5em;
  }
  
  .company-filter-item {
    min-width: 70px;
    padding: 3px 6px;
    font-size: 0.8em;
  }
}

#tooltipEl {
  direction: rtl !important;
  text-align: right !important;
}

/* עבור הטולטיפים המקוריים של Chart.js */
.chartjs-tooltip {
  direction: rtl !important;
  text-align: right !important;
}

/* QR code container styling */
#qrcode {
  margin: 15px auto;
  padding: 10px;
  background: white;
  border-radius: 4px;
}
/* סגנון ספציפי רק לכפתור העדכון מ-Multipass */
.multipass-update-button {
    flex-direction: row;  /* שינוי מהסידור הרגיל (column) לשורה */
    justify-content: center;  /* מרכוז אופקי */
    align-items: center;  /* מרכוז אנכי */
}

.multipass-update-button i {
    order: -1;  /* גורם לאייקון להופיע לפני הטקסט בסדר הויזואלי (כלומר מימין בעברית) */
    margin-left: 8px;  /* מרווח בין האייקון לטקסט */
    margin-right: 0;  /* מבטל מרווח מצד ימין */
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Variable to track if usage has been updated
  let usageUpdated = false;
  
  // Global variables for statistics
  let companiesData = [];
  let originalTimelineData = [];
  let selectedCompanies = new Set(['all']);
  let pieChart = null;
  let timelineChart = null;
  let lastClickedIndex = -1;
  let isShiftKeyPressed = false;
  
  // QR Code variable
  let qrCode = null;

  // Shift key tracking
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Shift') {
      isShiftKeyPressed = true;
    }
  });
  
  document.addEventListener('keyup', function(e) {
    if (e.key === 'Shift') {
      isShiftKeyPressed = false;
    }
  });

  // 1) Collect active coupons based on "קופונים פעילים" section
  const activeHeading = Array.from(document.querySelectorAll(".coupon-section-title"))
    .find(h => h.textContent.trim() === "קופונים פעילים");
  const activeContainer = activeHeading ? activeHeading.nextElementSibling : null;
  const activeCoupons = activeContainer ? activeContainer.querySelectorAll(".coupon-card-index-wrapper") : [];

  // 1.1) Collect one-time coupons
  const oneTimeHeading = Array.from(document.querySelectorAll(".coupon-section-title"))
    .find(h => h.textContent.trim() === "קופונים חד פעמיים");
  const oneTimeContainer = oneTimeHeading ? oneTimeHeading.nextElementSibling : null;
  const oneTimeCoupons = oneTimeContainer ? oneTimeContainer.querySelectorAll(".coupon-card-index-wrapper") : [];

  // 2) Group coupons by company
  const companyMap = {};
  activeCoupons.forEach(card => {
    const company = card.getAttribute("data-company") || "אחר";
    if (!companyMap[company]) {
      companyMap[company] = [];
    }
    companyMap[company].push(card);
  });

  // 2.1) Add one-time coupons to the group
  oneTimeCoupons.forEach(card => {
    const company = card.getAttribute("data-company") || "אחר";
    if (!companyMap[company]) {
      companyMap[company] = [];
    }
    companyMap[company].push(card);
  });

  // 3) Create company cards in the filter row
  const companyCardsRow = document.getElementById("company-cards-row");
  Object.keys(companyMap).forEach(company => {
    const cards = companyMap[company];
    const firstCard = cards[0];
    const logoSrc = firstCard.getAttribute("data-logo-src") || "";
    const count = cards.length;

    const cardBox = document.createElement("div");
    cardBox.classList.add("company-card-box");
    cardBox.setAttribute("data-company", company);

    const imgEl = document.createElement("img");
    imgEl.src = logoSrc;
    imgEl.alt = company;
    cardBox.appendChild(imgEl);

    const titleEl = document.createElement("h3");
    titleEl.textContent = company;
    cardBox.appendChild(titleEl);

    const pEl = document.createElement("p");
    pEl.textContent = count + " קופונים פעילים";
    cardBox.appendChild(pEl);

    cardBox.addEventListener("click", function() {
      openCompanyModal(company, cards);
    });

    companyCardsRow.appendChild(cardBox);
  });

  // 4) Modal for displaying company's coupons
  const modal = document.getElementById("companyModal");
  const modalCompanyName = document.getElementById("modal-company-name");
  const modalCompanyLogo = document.getElementById("modal-company-logo");
  const modalTotalRemaining = document.getElementById("modal-total-remaining");
  const modalCouponsList = document.getElementById("modal-coupons-list");
  const closeModal = document.querySelector(".close-modal");

  function openCompanyModal(companyName, cardList) {
    const firstCard = cardList[0];
    const logoSrc = firstCard.getAttribute("data-logo-src") || "";

    modalCompanyLogo.src = logoSrc;
    modalCompanyLogo.style.display = logoSrc ? "block" : "none";
    modalCompanyName.textContent = "קופונים מחברת " + companyName;

    let totalRemaining = 0;
    cardList.forEach(card => {
      const remainingVal = parseFloat(card.getAttribute("data-remaining")) || 0;
      totalRemaining += remainingVal;
    });
    modalTotalRemaining.textContent = "סה\"כ נותר: " + totalRemaining.toFixed(2) + " ₪";

    modalCouponsList.innerHTML = "";
    cardList.forEach(card => {
      const couponCode = card.getAttribute("data-coupon-code");
      const couponId = card.getAttribute("data-coupon-id");
      const remaining = parseFloat(card.getAttribute("data-remaining") || "0").toFixed(2);
      const couponLink = card.querySelector("a.view-details").getAttribute("href");
      const logoSrcItem = card.getAttribute("data-logo-src") || "";
      const isOneTime = card.getAttribute("data-is-one-time") === "true";
      const cvv = card.getAttribute("data-coupon-cvv") || "";
      const cardExp = card.getAttribute("data-coupon-card-index-exp") || "";

      const li = document.createElement("li");
      li.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center;">
          <a href="${couponLink}">
            קוד: ${couponCode} - ${isOneTime ? 'מטרה: ' + card.getAttribute("data-purpose") : 'נותר: ' + remaining + ' ₪'}
          </a>
          <div class="coupon-info-buttons">
            ${!isOneTime ? `
            <button
              class="update-usage-btn"
              data-coupon-id="${couponId}"
              data-coupon-code="${couponCode}"
              data-company="${companyName}"
              data-remaining="${remaining}"
              data-logo-src="${logoSrcItem}"
            >
              עדכון שימוש
            </button>
            ` : ''}
            <button
              class="show-big-btn"
              data-company="${companyName}"
              data-coupon-code="${couponCode}"
              data-logo-src="${logoSrcItem}"
              data-coupon-cvv="${cvv}"
              data-coupon-card-index-exp="${cardExp}"
            >
              הצגת קוד הקופון
            </button>
          </div>
        </div>
      `;
      modalCouponsList.appendChild(li);
    });

    modal.classList.add("active");
  }

  closeModal.addEventListener("click", function() {
    modal.classList.remove("active");
    if (usageUpdated) {
      window.location.reload();
    }
  });
  window.addEventListener("click", function(e) {
    if (e.target === modal) {
      modal.classList.remove("active");
      if (usageUpdated) {
        window.location.reload();
      }
    }
  });

  // 5) Modal for updating coupon usage
  const usageModal = document.getElementById("usageModal");
  const closeUsageModal = document.querySelector(".close-usage-modal");
  const usageCompany = document.getElementById("usage-modal-company");
  const usageCode = document.getElementById("usage-modal-code");
  const usageAmountInput = document.getElementById("usageAmount");
  const usageErrorMsg = document.getElementById("usageErrorMsg");
  const usageConfirmBtn = document.getElementById("usageConfirmButton");
  const updateFullAmountBtn = document.getElementById("updateFullAmountButton");

  let currentCouponId = null;
  let currentRemaining = 0;

  // Event delegation for update-usage buttons
  document.addEventListener("click", function(e) {
    if (e.target && (e.target.classList.contains("update-usage-btn") || e.target.classList.contains("update-usage"))) {
      let btn = e.target;
      let cardWrapper;
      
      if (e.target.classList.contains("update-usage")) {
        // For buttons in the new card layout
        cardWrapper = btn.closest(".coupon-card-index-wrapper");
        currentCouponId = cardWrapper.getAttribute("data-coupon-id");
        const cName = cardWrapper.getAttribute("data-company");
        const cCode = cardWrapper.getAttribute("data-coupon-code");
        currentRemaining = parseFloat(cardWrapper.getAttribute("data-remaining"));
        const logoSrc = cardWrapper.getAttribute("data-logo-src") || "";
        
        usageCompany.textContent = "חברה: " + cName;
        usageCode.innerHTML = "<strong>קוד קופון: " + cCode + "</strong>";
        usageAmountInput.value = "";
        usageErrorMsg.style.display = "none";
        document.getElementById("remainingValue").textContent = currentRemaining.toFixed(2);
        document.getElementById("usage-modal-logo").src = logoSrc;
        usageModal.classList.add("active");
      } else {
        // For buttons in the modal
        currentCouponId = btn.getAttribute("data-coupon-id");
        const cName = btn.getAttribute("data-company");
        const cCode = btn.getAttribute("data-coupon-code");
        currentRemaining = parseFloat(btn.getAttribute("data-remaining"));
        const logoSrc = btn.getAttribute("data-logo-src") || "";

        usageCompany.textContent = "חברה: " + cName;
        usageCode.innerHTML = "<strong>קוד קופון: " + cCode + "</strong>";
        usageAmountInput.value = "";
        usageErrorMsg.style.display = "none";
        document.getElementById("remainingValue").textContent = currentRemaining.toFixed(2);
        document.getElementById("usage-modal-logo").src = logoSrc;
        usageModal.classList.add("active");
      }
    }
  });

  closeUsageModal.addEventListener("click", function() {
    usageModal.classList.remove("active");
    if (usageUpdated) {
      window.location.reload();
    }
  });
  window.addEventListener("click", function(e) {
    if (e.target === usageModal) {
      usageModal.classList.remove("active");
      if (usageUpdated) {
        window.location.reload();
      }
    }
  });

  // Update full amount button handler
  updateFullAmountBtn.addEventListener("click", function() {
    usageAmountInput.value = currentRemaining;
  });

  usageConfirmBtn.addEventListener("click", function() {
    const usedAmount = parseFloat(usageAmountInput.value);
    if (isNaN(usedAmount) || usedAmount <= 0) {
      usageErrorMsg.textContent = "אנא הזן סכום חוקי (> 0).";
      usageErrorMsg.style.display = "block";
      return;
    }
    if (usedAmount > currentRemaining) {
      usageErrorMsg.textContent = "הסכום שהוזן חורג מהיתרה הקיימת (" + currentRemaining.toFixed(2) + " ש\"ח).";
      usageErrorMsg.style.display = "block";
      return;
    }
    usageErrorMsg.style.display = "none";

    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || "";
    fetch(`/update_coupon_usage/${currentCouponId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `csrf_token=${csrfToken}&used_amount=${usedAmount}`
    })
    .then(async response => {
      if (!response.ok) {
        const text = await response.text();
        usageErrorMsg.textContent = text || "שגיאה בעדכון השימוש.";
        usageErrorMsg.style.display = "block";
        return;
      }
      usageUpdated = true;
      usageModal.classList.remove("active");
      
      // Update UI after successful usage update
      updateUIAfterUsage(currentCouponId, usedAmount);
      
      const theButton = document.querySelector(`.update-usage-btn[data-coupon-id="${currentCouponId}"]`);
      if (theButton) {
        const oldRemaining = parseFloat(theButton.getAttribute("data-remaining")) || 0;
        const newRemaining = Math.max(0, oldRemaining - usedAmount).toFixed(2);
        theButton.setAttribute("data-remaining", newRemaining);
        const linkEl = theButton.parentElement.parentElement.querySelector("a");
        if (linkEl) {
          const codeText = linkEl.textContent.split("- נותר:");
          if (codeText.length === 2) {
            linkEl.textContent = codeText[0] + "- נותר: " + newRemaining + " ₪";
          }
        }
      }
    })
    .catch(err => {
      usageErrorMsg.textContent = "שגיאה בלתי צפויה: " + err;
      usageErrorMsg.style.display = "block";
    });
  });

  // Function to update UI after successful usage update
  function updateUIAfterUsage(couponId, usedAmount) {
    // Update the coupon card in the main UI
    const cardWrapper = document.querySelector(`.coupon-card-index-wrapper[data-coupon-id="${couponId}"]`);
    if (cardWrapper) {
      const oldRemaining = parseFloat(cardWrapper.getAttribute("data-remaining")) || 0;
      const newRemaining = Math.max(0, oldRemaining - usedAmount).toFixed(2);
      
      // Update the data attribute
      cardWrapper.setAttribute("data-remaining", newRemaining);
      
      // Update the displayed remaining value
      const valueElement = cardWrapper.querySelector('.coupon-value .value');
      if (valueElement) {
        valueElement.textContent = newRemaining + " ₪";
      }
      
      // Update progress bar if exists
      if (cardWrapper.querySelector('.progress-fill')) {
        const couponValue = parseFloat(oldRemaining) + parseFloat(usedAmount);
        if (couponValue > 0) {
          const usedValue = couponValue - parseFloat(newRemaining);
          const percentage = (usedValue / couponValue * 100).toFixed(1);
          
          cardWrapper.querySelector('.progress-text').textContent = `שימוש: ${percentage}%`;
          cardWrapper.querySelector('.progress-fill').style.width = `${percentage}%`;
        }
      }
    }
  }

  // 6) Modal for large display of coupon code
  const bigModal = document.getElementById("bigDisplayModal");
  const closeBigModal = document.querySelector(".close-big-modal");
  const bigModalCompanyName = document.getElementById("bigModalCompanyName");
  const bigModalLogo = document.getElementById("bigModalLogo");
  const bigModalCouponCode = document.getElementById("bigModalCouponCode");
  const bigModalExtraDetails = document.getElementById("bigModalExtraDetails");
  const bigModalCouponCVV = document.getElementById("bigModalCouponCVV");
  const bigModalCardExp = document.getElementById("bigModalCardExp");
  const qrCodeContainer = document.getElementById("qrcode");

  // Generate QR code function
  function generateQRCode(code) {
    if (typeof QRCode !== 'undefined') {
      // Clear previous QR code
      qrCodeContainer.innerHTML = '';
      
      // Create new QR code
      qrCode = new QRCode(qrCodeContainer, {
        text: code,
        width: 200,
        height: 200,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
    }
  }

  // Event delegation for show-code buttons
  document.addEventListener("click", function(e) {
    if (e.target && (e.target.classList.contains("show-big-btn") || e.target.classList.contains("show-code"))) {
      let btn = e.target;
      let company, couponCode, logoSrc, couponCVV, couponCardExp;
      
      if (e.target.classList.contains("show-code")) {
        // For buttons in the new card layout
        const cardWrapper = btn.closest(".coupon-card-index-wrapper");
        company = cardWrapper.getAttribute("data-company");
        couponCode = cardWrapper.getAttribute("data-coupon-code");
        logoSrc = cardWrapper.getAttribute("data-logo-src") || "";
        couponCVV = cardWrapper.getAttribute("data-coupon-cvv");
        couponCardExp = cardWrapper.getAttribute("data-coupon-card-index-exp");
      } else {
        // For buttons in the modal
        company = btn.getAttribute("data-company");
        couponCode = btn.getAttribute("data-coupon-code");
        logoSrc = btn.getAttribute("data-logo-src") || "";
        couponCVV = btn.getAttribute("data-coupon-cvv");
        couponCardExp = btn.getAttribute("data-coupon-card-index-exp");
      }

      bigModalCompanyName.textContent = company;
      bigModalLogo.src = logoSrc;
      bigModalCouponCode.textContent = couponCode;

      if (couponCVV || couponCardExp) {
        bigModalExtraDetails.style.display = "block";
        bigModalCouponCVV.textContent = couponCVV ? `${couponCVV} :CVV` : "";
        bigModalCardExp.textContent = couponCardExp ? `תוקף: ${couponCardExp}` : "";
      } else {
        bigModalExtraDetails.style.display = "none";
      }
      
      // Generate QR code
      generateQRCode(couponCode);

      bigModal.classList.add("active");
    }
  });

  closeBigModal.addEventListener("click", function() {
    bigModal.classList.remove("active");
  });
  window.addEventListener("click", function(e) {
    if (e.target === bigModal) {
      bigModal.classList.remove("active");
    }
  });

  // 7) Close admin message
  document.querySelectorAll(".close-button").forEach(button => {
    button.addEventListener("click", function (event) {
        event.preventDefault();
        let form = this.closest("form");
        let url = form.action;
        let csrfToken = form.querySelector("input[name='csrf_token']").value;
        fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `csrf_token=${csrfToken}`
        }).then(response => {
            if (response.ok) {
                form.closest(".admin-flash-message").remove();
            } else {
                alert("שגיאה בעת סגירת ההודעה");
            }
        });
    });
  });

  // 8) Statistics modal functionality with real data
  // Function to render charts and initialize filtering
  function renderSavingsCharts() {
    try {
      // קרא את הנתונים שהועברו מהשרת
      companiesData = JSON.parse('{{ companies_stats|safe }}');
      originalTimelineData = JSON.parse('{{ timeline_data|safe }}');

      // בדיקה שהנתונים קיימים וחוקיים
      if (!Array.isArray(companiesData) || companiesData.length === 0) {
        console.error("Error: companies_stats is empty or not an array");
        companiesData = [];
      }

      // ארגון הנתונים לפי פורמט התרשים
      const pieData = companiesData.map(item => ({
        company: item.company,
        value: item.savings || 0
      }));

      // מיון החברות לפי סכום החיסכון (מהגבוה לנמוך)
      const sortedCompanies = companiesData
        .sort((a, b) => (b.savings || 0) - (a.savings || 0))
        .map(item => item.company);
      
      createCompanyFilters(sortedCompanies);
      updateStatisticsCards(companiesData);
      updateSavingsTable(companiesData);
      createPieChart(pieData);
      createTimelineChart(originalTimelineData);
      
      // Add resize event listener for better mobile responsiveness
      window.addEventListener('resize', function() {
        if (pieChart) {
          const isMobile = window.innerWidth < 768;
          // Update legend position based on screen size
          if (pieChart.options && pieChart.options.plugins && pieChart.options.plugins.legend) {
            pieChart.options.plugins.legend.position = isMobile ? 'bottom' : 'right';
            pieChart.update();
          }
        }
      });
    } catch (e) {
      console.error("Error parsing statistics data:", e);
      companiesData = [];
    }
  }

  // Update statistics cards based on filtered data
  function updateStatisticsCards(data) {
    let totalSavings = 0;
    let totalPossibleValue = 0;
    let totalCoupons = 0;
    let activeCoupons = 0;
    let totalUsagePercentage = 0;

    data.forEach(company => {
      totalSavings += company.savings || 0;
      totalPossibleValue += company.total_value || 0;
      totalCoupons += company.coupons_count || 0;
      activeCoupons += company.active_coupons || 0;
      totalUsagePercentage += ((company.usage_percentage || 0) * (company.coupons_count || 0));
    });

    const avgUsagePercentage = totalCoupons > 0 ? totalUsagePercentage / totalCoupons : 0;
    const savingsPercentage = totalPossibleValue > 0 ? (totalSavings / totalPossibleValue) * 100 : 0;

    // עדכון הכרטיסיות
    document.querySelector('#total-savings-card .big-number').textContent = Math.round(totalSavings).toString() + ' ₪';
    document.querySelector('#total-savings-card p').textContent = 'מתוך ' + Math.round(totalPossibleValue).toString() + ' ₪ אפשריים';
    
    document.querySelector('#savings-percentage-card .big-number').textContent = Math.round(savingsPercentage).toString() + '%';
    
    document.querySelector('#total-coupons-card .big-number').textContent = totalCoupons.toString();
    document.querySelector('#total-coupons-card p').textContent = activeCoupons.toString() + ' מתוכם פעילים';
    
    document.querySelector('#average-usage-card .big-number').textContent = Math.round(avgUsagePercentage).toString() + '%';
  }

  // Create filter controls for companies - UPDATED to support multiple selections and shift+click
  function createCompanyFilters(companies) {
    const filtersContainer = document.getElementById('company-filters');
    filtersContainer.innerHTML = '';
    
    const allFilter = document.createElement('div');
    allFilter.className = 'company-filter-item active';
    allFilter.dataset.company = 'all';
    allFilter.dataset.index = -1;
    allFilter.innerHTML = '<span>הכל</span>';
    filtersContainer.appendChild(allFilter);
    
    companies.forEach((company, index) => {
      const filterItem = document.createElement('div');
      filterItem.className = 'company-filter-item';
      filterItem.dataset.company = company;
      filterItem.dataset.index = index;
      filterItem.innerHTML = `<span>${company}</span>`;
      filtersContainer.appendChild(filterItem);
    });
    
    // מניעת סימון טקסט בעת שימוש ב-Shift+Click
    document.querySelectorAll('.company-filter-item').forEach(item => {
      item.addEventListener('mousedown', function(e) {
        if (isShiftKeyPressed) {
          e.preventDefault();
        }
      });
    });

    // הוספת אירוע לחיצה עם תמיכה בבחירה מרובה
    document.querySelectorAll('.company-filter-item').forEach(item => {
      item.addEventListener('click', function(e) {
        const companyName = this.dataset.company;
        const currentIndex = parseInt(this.dataset.index);
        
        // טיפול בלחיצה על "הכל"
        if (companyName === 'all') {
          document.querySelectorAll('.company-filter-item').forEach(i => {
            i.classList.remove('active');
          });
          this.classList.add('active');
          selectedCompanies.clear();
          selectedCompanies.add('all');
          lastClickedIndex = -1;
        } else {
          // טיפול בלחיצת Shift לבחירה מרובה
          if (isShiftKeyPressed && lastClickedIndex !== -1 && lastClickedIndex !== currentIndex) {
            // הסרת "הכל" אם נבחר
            const allItem = document.querySelector('.company-filter-item[data-company="all"]');
            allItem.classList.remove('active');
            selectedCompanies.delete('all');
            
            // קביעת הטווח לבחירה
            const start = Math.min(lastClickedIndex, currentIndex);
            const end = Math.max(lastClickedIndex, currentIndex);

            // איסוף כל האלמנטים בסדר הטבעי שלהם בדף
            const allItems = Array.from(document.querySelectorAll('.company-filter-item'));
            const allIndices = allItems.map(item => parseInt(item.dataset.index));
            const itemsInRange = allItems.filter(item => {
              const idx = parseInt(item.dataset.index);
              return idx >= start && idx <= end && idx !== -1; // לא לכלול את אפשרות "הכל"
            });

            // בחירת כל החברות בטווח
            itemsInRange.forEach(item => {
              if (!item.classList.contains('active')) {
                item.classList.add('active');
                selectedCompanies.add(item.dataset.company);
              }
            });
          } else {
            // החלפת מצב פעיל/לא פעיל לחברה הנוכחית (ללא Shift)
            // הסרת "הכל" אם נבחר חברה ספציפית
            const allItem = document.querySelector('.company-filter-item[data-company="all"]');
            allItem.classList.remove('active');
            selectedCompanies.delete('all');
            
            // החלפת מצב פעיל/לא פעיל לחברה הנוכחית
            if (this.classList.contains('active')) {
              this.classList.remove('active');
              selectedCompanies.delete(companyName);
              
              // אם אין חברות נבחרות, החזר ל"הכל"
              if (document.querySelectorAll('.company-filter-item.active').length === 0) {
                allItem.classList.add('active');
                selectedCompanies.add('all');
                lastClickedIndex = -1;
              }
            } else {
              this.classList.add('active');
              selectedCompanies.add(companyName);
            }
          }
          
          // שמירת האינדקס האחרון שנלחץ (לשימוש ב-Shift+Click)
          if (currentIndex >= 0) {
            lastClickedIndex = currentIndex;
          }
        }
        
        filterAndUpdateCharts();
      });
    });
  }

  // Filter data and update charts/table based on selected companies
  function filterAndUpdateCharts() {
    let filteredData;
    
    if (selectedCompanies.has('all')) {
      filteredData = companiesData;
      
      // עדכון כל הגרפים והטבלאות
      const pieData = companiesData.map(item => ({
        company: item.company,
        value: item.savings || 0
      }));
      
      updatePieChart(pieData);
      updateTimelineChart(originalTimelineData);
    } else {
      // סינון הנתונים לפי החברות שנבחרו
      filteredData = companiesData.filter(item => selectedCompanies.has(item.company));
      
      // עדכון גרף העוגה
      const filteredPieData = filteredData.map(item => ({
        company: item.company,
        value: item.savings || 0
      }));
      
      updatePieChart(filteredPieData);
      
      // סינון נתוני ציר הזמן לפי החברות שנבחרו
      if (originalTimelineData && originalTimelineData.length) {
        // Filter timeline data based on selected companies
        const filteredTimelineData = originalTimelineData.filter(item => {
          // If the timeline data has company information
          if (item.company) {
            return selectedCompanies.has(item.company);
          }
          // If there's no company info, keep the data point
          return true;
        });
        
        updateTimelineChart(filteredTimelineData.length > 0 ? filteredTimelineData : originalTimelineData);
      }
    }
    
    updateStatisticsCards(filteredData);
    updateSavingsTable(filteredData);
  }

  // Update the savings table with company-specific savings percentages
  function updateSavingsTable(data) {
    const tableBody = document.querySelector("#savingsTable tbody");
    tableBody.innerHTML = '';
    
    data.forEach(item => {
      // החיסכון באחוזים מתוך ערך הקופונים של החברה
      const percentOfCompany = item.total_value > 0 ? 
        (item.savings / item.total_value * 100).toFixed(1) : "0.0";
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.company}</td>
        <td>${(item.savings || 0).toFixed(2)} ₪</td>
        <td>${percentOfCompany}%</td>
      `;
      tableBody.appendChild(row);
    });
  }

  // Create pie chart for company savings distribution
  function createPieChart(pieData) {
    if (typeof Chart !== 'undefined') {
      document.getElementById('companySavingsChart').innerHTML = '';
      const canvas = document.createElement('canvas');
      document.getElementById('companySavingsChart').appendChild(canvas);
      const ctx = canvas.getContext('2d');
      
      // Standard colors for the pie chart
      const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', 
        '#FF9F40', '#50AF95', '#7E57C2', '#2196F3', '#F44336',
        '#4CAF50', '#FF5722', '#9C27B0', '#673AB7', '#3F51B5'
      ];
      
      // Create enough colors for all data points
      const backgroundColors = [];
      for (let i = 0; i < pieData.length; i++) {
        backgroundColors.push(colors[i % colors.length]);
      }
            
      // ייצור מיפוי של נתוני החברות המלאים להצגת פרטים בטולטיפ
      const companyDetailsMap = {};
      pieData.forEach((item, index) => {
        // מוצא את הנתונים המלאים של החברה
        const fullCompanyData = companiesData.find(c => c.company === item.company);
        if (fullCompanyData) {
          companyDetailsMap[item.company] = fullCompanyData;
        }
      });
      
      // Responsive legend position based on screen size
      const isMobile = window.innerWidth < 768;
      
      pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: pieData.map(d => d.company),
          datasets: [{
            data: pieData.map(d => d.value),
            backgroundColor: backgroundColors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: isMobile ? 'bottom' : 'right',
              labels: { 
                font: { size: isMobile ? 10 : 12 },
                boxWidth: isMobile ? 10 : 15
              }
            },
            tooltip: {
              rtl: true, // הגדרת כיוון הטקסט לימין-לשמאל
              textDirection: 'rtl',
              // עיצוב מותאם לטולטיפ
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleFont: {
                size: 14
              },
              bodyFont: {
                size: 14
              },
              padding: 12,
              titleAlign: 'right',
              bodyAlign: 'right',
              callbacks: {
                // טיפול בשורות הטקסט להצגה מימין לשמאל
                label: function(context) {
                  const company = context.label;
                  const value = context.raw;
                  const companyData = companiesData.find(c => c.company === company);
                  
                  if (!companyData) return [`${value.toFixed(2)} :${company}`];
                  
                  // בניית שורות הטקסט עם סימן הנקודתיים מהצד השמאלי
                  // כדי שבתצוגה RTL הטקסט יראה כאילו הנקודתיים בצד ימין
                  const lines = [
                    `${value.toFixed(2)} :${company}`
                  ];
                  
                  // חישוב אחוז מסך החיסכון
                  const totalSavings = companiesData.reduce((sum, c) => sum + (c.savings || 0), 0);
                  const savingsPercentage = totalSavings > 0 ? ((value / totalSavings) * 100).toFixed(1) : "0.0";
                  lines.push(`${savingsPercentage}% :אחוז מסך החיסכון`);
                  
                  // מספר קופונים אם קיים
                  if (companyData.coupons_count !== undefined) {
                    lines.push(`${companyData.coupons_count} :מספר קופונים`);
                  }
                  
                  // אחוז ניצול אם קיים
                  if (companyData.usage_percentage !== undefined) {
                    lines.push(`${companyData.usage_percentage.toFixed(1)}% :אחוז ניצול`);
                  }
                  
                  // יתרה אם קיימת
                  if (companyData.remaining_value !== undefined) {
                    lines.push(`₪ ${companyData.remaining_value.toFixed(2)} :יתרה`);
                  }
                  
                  return lines;
                },
                // התאמת הסדר של כותרת הטולטיפ
                title: function(tooltipItems) {
                  return ''; // אופציונלי: להסיר את הכותרת המקורית
                }
              }
            }
          }
        }
      });
    } else {
      document.getElementById('companySavingsChart').innerHTML = '<p style="text-align:center;padding-top:80px;">לצפייה בגרף יש להתקין ספריית Chart.js</p>';
    }
  }

  // Update pie chart data
  function updatePieChart(pieData) {
    if (pieChart) {
      pieChart.data.labels = pieData.map(d => d.company);
      pieChart.data.datasets[0].data = pieData.map(d => d.value);
      pieChart.update();
    }
  }

  // Create timeline (line) chart with real data
  function createTimelineChart(timelineData) {
    if (typeof Chart !== 'undefined') {
      document.getElementById('timelineChart').innerHTML = '';
      const canvas = document.createElement('canvas');
      document.getElementById('timelineChart').appendChild(canvas);
      const ctx = canvas.getContext('2d');
      
      // Responsive font size based on screen size
      const isMobile = window.innerWidth < 768;
      const fontSize = isMobile ? 10 : 12;
      
      timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: timelineData.map(d => d.month),
          datasets: [{
            label: 'חיסכון חודשי (ש"ח)',
            data: timelineData.map(d => d.value),
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.2)',
            borderWidth: 2,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { 
            y: { 
              beginAtZero: true,
              ticks: {
                font: { size: fontSize }
              }
            },
            x: {
              ticks: {
                font: { size: fontSize },
                maxRotation: isMobile ? 45 : 0
              }
            }
          },
          plugins: {
            legend: {
              labels: { 
                font: { size: fontSize }
              }
            }
          }
        }
      });
    } else {
      document.getElementById('timelineChart').innerHTML = '<p style="text-align:center;padding-top:80px;">לצפייה בגרף יש להתקין ספריית Chart.js</p>';
    }
  }
  
  // Update timeline chart data
  function updateTimelineChart(timelineData) {
    if (timelineChart) {
      timelineChart.data.labels = timelineData.map(d => d.month);
      timelineChart.data.datasets[0].data = timelineData.map(d => d.value);
      timelineChart.update();
    }
  }

  // Open statistics modal and render charts
  const statsModal = document.getElementById("statsModal");
  const openStatsModalBtn = document.getElementById("open-stats-modal");
  const closeStatsModal = document.querySelector(".close-stats-modal");

  if (openStatsModalBtn) {
    openStatsModalBtn.addEventListener("click", function() {
      statsModal.classList.add("active");
      renderSavingsCharts();
    });
  }
  
  if (closeStatsModal) {
    closeStatsModal.addEventListener("click", function() {
      statsModal.classList.remove("active");
    });
  }
  
  window.addEventListener("click", function(e) {
    if (e.target === statsModal) {
      statsModal.classList.remove("active");
    }
  });
});
</script>
<script src="{{ url_for('static', filename='js/tooltip.js') }}" defer></script>
{% endblock %}